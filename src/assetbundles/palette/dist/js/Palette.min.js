/**
 * Command palette for Craft.
 *
 * @author    a&m impact
 * @copyright Copyright (c) 2017 a&m impact
 * @link      http://www.am-impact.nl
 */

!function(e){Craft.Palette=Garnish.Base.extend({$searchField:e(".palette__search input[type=text]"),$container:e(".palette"),$tabsContainer:e(".palette__tabs"),$searchContainer:e(".palette__search"),$commandsContainer:e(".palette__commands ul"),$loader:e(".palette__loader"),$commands:e(".palette__commands li"),$button:e("#nav-command-palette"),P_KEY:80,NUM_KEYS:[49,50,51,52,53,54,55,56,57],ignoreSearchKeys:[Garnish.UP_KEY,Garnish.DOWN_KEY,Garnish.LEFT_KEY,Garnish.RIGHT_KEY,Garnish.RETURN_KEY,Garnish.ESC_KEY,Garnish.CMD_KEY,Garnish.CTRL_KEY],commandsArray:[],elementCommandsArray:[],combinedCommandsArray:[],searchedCommandsArray:[],rememberPalette:{currentSet:0,paletteStyle:[],commandNames:[],commandsArray:[],searchKeywords:[],actions:[]},isOpen:!1,isHtml:!1,isAction:!1,isActionAsync:!0,isActionRealtime:!1,actionData:[],actionTimer:!1,loadingCommand:"",loadingRequest:!1,loadingElements:!1,allowElementSearch:!0,elementSearchTimer:!1,init:function(e){var a=this;a.commandsArray=e,a.combinedCommandsArray=e,a.bindEvents()},bindEvents:function(){var a=this;a.addListener(a.$button,"click","openPalette"),a.addListener(a.$searchField,"keyup",function(t){a.ignoreSearchKeys.indexOf(t.keyCode)<0&&(a.search(t,!1,!1),a.isOpen&&a.allowElementSearch&&a.$searchField.val().length&&(a.elementSearchTimer&&clearTimeout(a.elementSearchTimer),a.elementSearchTimer=setTimeout(e.proxy(function(){var e={option:"DirectElements",searchText:a.$searchField.val()};a.triggerCallback("searchOn","command-palette","search",e,!0)},this),600)))}),a.addListener(window,"keydown",function(e){(e.metaKey||e.ctrlKey)&&e.shiftKey&&e.keyCode==a.P_KEY?a.isOpen?a.closePalette(e):a.openPalette(e):(e.metaKey||e.ctrlKey)&&a.NUM_KEYS.indexOf(e.keyCode)>-1?a.triggerCommand(e,!1):e.keyCode==Garnish.UP_KEY?a.moveCommandFocus(e,"up"):e.keyCode==Garnish.DOWN_KEY?a.moveCommandFocus(e,"down"):e.keyCode==Garnish.RETURN_KEY?a.triggerCommand(e,e.metaKey||e.ctrlKey):e.keyCode==Garnish.ESC_KEY&&(a.rememberPalette.currentSet>0?a.restoreCommands():a.closePalette(e))}),a.addListener(document.body,"click","closePalette"),a.addListener(a.$container,"click",function(e){e.stopPropagation()})},openPalette:function(e){var a=this;a.isOpen||(a.$container.fadeIn(1,function(){a.isOpen=!0,a.$searchField.focus(),a.$commandsContainer.addClass("hidden")}),e.preventDefault())},closePalette:function(e){var a=this;a.isOpen&&(a.$container.fadeOut(1,function(){a.$searchField.val(""),a.$tabsContainer.addClass("hidden"),a.rememberPalette.currentSet>0&&(a.isAction=!1,a.isActionAsync=!0,a.isActionRealtime=!1,a.actionData=[],a.rememberPalette.currentSet=0,a.commandsArray=a.rememberPalette.commandsArray[1]),a.search(e,!1,!1),a.isOpen=!1,a.loadingRequest&&(a.loadingRequest.abort(),a.$loader.addClass("hidden")),a.loadingRequest=!1,a.loadingElements=!1}),void 0!==e&&e.preventDefault())},resetPalette:function(){var a=this;a.$commands=e(".palette__commands li"),a.addListener(a.$commands,"click","triggerCommand"),a.$commands.first().addClass("focus")},search:function(a,t,n){var r=this;if(r.isAction&&!t||r.loadingRequest&&!r.loadingElements)r.isAction&&r.isActionRealtime&&(r.actionTimer&&clearTimeout(r.actionTimer),r.actionTimer=setTimeout(e.proxy(function(){r.triggerRealtimeAction()},this),600));else{var i=r.allowElementSearch?r.combinedCommandsArray:r.commandsArray,s=t?"":r.$searchField.val(),o=fuzzysort.go(s,i,{keys:["name","info"],scoreFn:function(e){return Math.max(e[0]?e[0].score:-1e3,e[1]?e[1].score-100:-1e3)}}),m=(o.length,!0);if(r.searchedCommandsArray=[],!r.allowElementSearch||s.length&&r.allowElementSearch){var c=r.renderCommands(o);if(c.length||""!=s||r.allowElementSearch||(c=r.renderCommands(i)),n){var l=r.$commands.length;l==c.length&&(m=!1)}m&&(r.$commandsContainer.removeClass("hidden"),r.$commandsContainer.html(c.join("")),c.length||r.$commandsContainer.addClass("hidden"),r.resetPalette())}else r.$commandsContainer.html(""),r.$commandsContainer.addClass("hidden")}},renderCommands:function(e){var a=this,t=-1,n=e.map(function(e){var n=e,r=n.name,i=n.info;if("obj"in e)if(n=e.obj,r=n.name,i=n.info,null!==e[0])e[0].target==i?i=fuzzysort.highlight(e[0]):r=fuzzysort.highlight(e[0]);else{if(null===e[1])return"";e[1].target==i?i=fuzzysort.highlight(e[1]):r=fuzzysort.highlight(e[1])}a.searchedCommandsArray.push(n),t++;var s="icon"in n?'<span class="palette__command__icon"'+("font"==n.icon.type?' data-icon="'+n.icon.content+'"':"")+">"+("font"!=n.icon.type?n.icon.content:"")+"</span>":"",o=9>t?'<span class="palette__command__shortcut">&#8984;'+(t+1)+"</span>":"";return r='<span class="palette__command__name'+("more"in n&&n.more?" go":"")+'">'+r+"</span>",i=i.length?'<span class="palette__command__info">'+i+"</span>":"",'<li data-id="'+t+'">'+s+'<div class="palette__command__content">'+r+i+"</div>"+o+"</li>"});return n},moveCommandFocus:function(e,a){var t=this;if(t.isOpen){var n=t.$commands.filter(".focus");switch(a){case"up":var r=n.prev();r.length&&(r.addClass("focus"),n.removeClass("focus"),t.keepCommandVisible(r));break;case"down":var i=n.next();i.length&&(i.addClass("focus"),n.removeClass("focus"),t.keepCommandVisible(i))}e.preventDefault()}},keepCommandVisible:function(e){var a=this,t=e.offset().top,n=e.outerHeight(),r=a.$commandsContainer.offset().top,i=a.$commandsContainer.scrollTop(),s=a.$commandsContainer.height();t+n>s+r?a.$commandsContainer.scrollTop(t-r-s+n+i):r>t&&a.$commandsContainer.scrollTop(i-r+t)},displayMessage:function(e,a,t){e?a!==!1?Craft.cp.displayNotice(a):Craft.cp.displayNotice('<span class="palette__notice">'+Craft.t("command-palette","Command executed")+" &raquo;</span>"+t):Craft.cp.displayError(a)},rememberCommands:function(){var e=this,a={isAction:e.isAction,isActionAsync:e.isActionAsync,isActionRealtime:e.isActionRealtime,actionData:e.actionData};e.rememberPalette.currentSet++,e.rememberPalette.paletteStyle[e.rememberPalette.currentSet]={width:e.$container.width()},e.rememberPalette.commandNames[e.rememberPalette.currentSet]=e.loadingCommand,e.rememberPalette.commandsArray[e.rememberPalette.currentSet]=e.commandsArray,e.rememberPalette.searchKeywords[e.rememberPalette.currentSet]=e.$searchField.val(),e.rememberPalette.actions[e.rememberPalette.currentSet]=a,e.isAction&&!e.isActionRealtime&&(e.isAction=!1,e.isActionAsync=!0,e.actionData=[]),e.rememberPalette.currentSet>0&&(e.allowElementSearch=!1)},restoreCommands:function(){var e=this,a=e.rememberPalette.actions[e.rememberPalette.currentSet];e.isHtml&&(e.isHtml=!1,e.$searchContainer.removeClass("hidden"),e.$container.velocity(e.rememberPalette.paletteStyle[e.rememberPalette.currentSet],400)),e.isAction&&(e.isAction=!1,e.isActionAsync=!0,e.isActionRealtime=!1,e.actionData=[]),e.loadingRequest&&(e.loadingRequest.abort(),e.$loader.addClass("hidden")),e.loadingRequest=!1,e.loadingElements=!1,e.commandsArray=e.rememberPalette.commandsArray[e.rememberPalette.currentSet],e.$searchField.val(e.rememberPalette.searchKeywords[e.rememberPalette.currentSet]),e.$searchField.focus(),e.rememberPalette.currentSet--,0==e.rememberPalette.currentSet&&(e.allowElementSearch=!0,e.combinedCommandsArray=e.commandsArray.concat(e.elementCommandsArray)),e.search(void 0,!1,!1),e.rememberPalette.currentSet>0?e.$tabsContainer.text(e.rememberPalette.commandNames[e.rememberPalette.currentSet]):e.$tabsContainer.addClass("hidden"),a.isAction&&(e.isAction=!0,e.isActionAsync=a.isActionAsync,e.isActionRealtime=a.isActionRealtime,e.actionData=a.actionData)},triggerRealtimeAction:function(){var e=this;e.actionTimer&&(clearTimeout(e.actionTimer),e.actionTimer=!1);var a=e.actionData.vars;a.searchText=e.$searchField.val(),e.triggerCallback(e.actionData.call,e.actionData.plugin,e.actionData.service,a,!1)},triggerCommand:function(a,t){var n=this;if(n.isOpen){if(n.isAction&&!n.isActionRealtime){var r=n.actionData.vars;r.searchText=n.$searchField.val(),n.triggerCallback(n.actionData.call,n.actionData.plugin,n.actionData.service,r,!1)}else{if("click"==a.type){(a.ctrlKey||a.metaKey)&&(t=!0);var i=e(a.currentTarget);n.$commands.removeClass("focus"),i.addClass("focus")}else if("keydown"==a.type&&n.NUM_KEYS.indexOf(a.keyCode)>-1)var s=n.NUM_KEYS.indexOf(a.keyCode),i=n.$commands.filter(":eq("+s+")");else var i=n.$commands.filter(".focus");if(i.length){var o=i.data("id");if(o in n.searchedCommandsArray){var m=!0,c=n.searchedCommandsArray[o],l="warn"in c?c.warn:!1,d="url"in c?c.url:!1,h="call"in c?c.call:!1,u="plugin"in c?c.plugin:!1,C="service"in c?c.service:!1,f="vars"in c?c.vars:!1;if(n.loadingCommand=c.name,l){var y=confirm(Craft.t("command-palette","Are you sure you want to execute this command?"));y||(m=!1)}m&&(h?n.triggerCallback(h,u,C,f,!1):d&&(t?window.open(d):window.location=d,n.displayMessage(!0,!1,c.name),n.closePalette(a)))}}}a.preventDefault()}},triggerCallback:function(a,t,n,r,i){var s=this,o=!1,m=!1,c=s.$commands.filter(".focus");s.loadingRequest?s.loadingElements&&(o=!0,s.loadingRequest&&(s.loadingElements=!1,s.loadingRequest.abort())):o=!0,o&&(i||s.$commands.hide(),s.$loader.removeClass("hidden"),i&&(s.loadingElements=!0),s.loadingRequest=Craft.postActionRequest("command-palette/commands/trigger-command",{command:a,plugin:t,service:n,vars:r},e.proxy(function(e,a){s.loadingRequest=!1,"success"==a&&(s.$loader.addClass("hidden"),e.success?(e.title&&(s.loadingCommand=e.title),e.isHtml?""==e.result?s.$commands.show():(s.rememberCommands(),s.isHtml=!0,s.$tabsContainer.text(s.loadingCommand),s.$tabsContainer.removeClass("hidden"),s.$searchContainer.addClass("hidden"),s.$container.velocity({width:"80%"},400),s.$commandsContainer.html(e.result),Craft.appendHeadHtml(e.headHtml),Craft.appendFootHtml(e.footHtml),Craft.initUiElements(s.$commandsContainer)):i&&e.isNewSet?(s.loadingElements=!1,s.elementCommandsArray=e.result,s.combinedCommandsArray=s.commandsArray.concat(s.elementCommandsArray),s.search(void 0,!1,!0)):s.isAction&&s.isActionRealtime&&e.isNewSet?(s.commandsArray=e.result,s.search(void 0,!0,!1)):e.isAction?(s.loadingCommand=e.isAction.tabs,s.rememberCommands(),s.isAction=!0,s.isActionAsync=e.isAction.async,s.isActionRealtime=e.isAction.realtime,s.actionData=e.isAction,s.$tabsContainer.text(e.isAction.tabs),s.$tabsContainer.removeClass("hidden"),s.commandsArray=[],s.$commandsContainer.html(""),s.$commandsContainer.addClass("hidden"),s.$searchField.val(e.isAction.searchText),s.$searchField.focus()):e.isNewSet?""==e.result?s.$commands.show():(s.rememberCommands(),s.$tabsContainer.text(s.loadingCommand),s.$tabsContainer.removeClass("hidden"),s.$searchField.val(""),s.$searchField.focus(),s.commandsArray=e.result,s.search(void 0,!1,!1)):e.deleteCommand?(s.$searchField.val(""),s.$searchField.focus(),s.$commands.removeClass("focus"),s.deleteCommand(c.data("id")),s.search(void 0,!0,!1),s.$commands.show(),s.commandsArray.length<=0&&(s.displayMessage(!1,Craft.t("command-palette","There are no more commands available."),!1),s.closePalette())):(m=!0,s.closePalette()),e.message?s.displayMessage(""!=e.result,e.message,!1):m&&s.displayMessage(!0,!1,s.loadingCommand),e.redirect&&(e.redirect.newWindow?window.open(e.redirect.url):window.location=e.redirect.url)):(s.isAction&&s.isActionRealtime&&(s.commandsArray=[],s.$commandsContainer.html(""),s.$commandsContainer.addClass("hidden")),s.$commands.show(),s.$searchField.focus(),i||s.displayMessage(!1,e.message,!1)))},s),{async:s.isActionAsync,complete:function(e,a){}}))},deleteCommand:function(e){var a=this,t=a.commandsArray.length;if(t){for(;t>e;)a.commandsArray[e]=a.commandsArray[e+1],e++;a.commandsArray.length--}}})}(jQuery);
